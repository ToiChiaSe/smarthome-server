<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Smart Home Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-light">
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary">üè† Smart Home Dashboard</h2>
    <form method="post" action="/logout">
      <button class="btn btn-outline-danger btn-sm">ƒêƒÉng xu·∫•t</button>
    </form>
  </div>

  <!-- ƒêi·ªÅu khi·ªÉn + Tr·∫°ng th√°i -->
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</div>
        <div class="card-body" id="device-controls"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">Tr·∫°ng th√°i thi·∫øt b·ªã</div>
        <div class="card-body" id="device-status"></div>
      </div>
    </div>
  </div>

  <!-- Bi·ªÉu ƒë·ªì c·∫£m bi·∫øn -->
  <div class="card shadow mb-4">
    <div class="card-header bg-info text-white">Th√¥ng s·ªë c·∫£m bi·∫øn</div>
    <div class="card-body">
      <canvas id="sensorChart" height="120"></canvas>
    </div>
  </div>

  <!-- B√°o c√°o th·ªëng k√™ -->
  <div class="card shadow mb-4">
    <div class="card-header bg-warning text-dark">B√°o c√°o th·ªëng k√™</div>
    <div class="card-body">
      <p>Nhi·ªát ƒë·ªô trung b√¨nh: <span id="avg-temp">--</span> ¬∞C</p>
      <p>ƒê·ªô ·∫©m trung b√¨nh: <span id="avg-hum">--</span> %</p>
      <p>√Ånh s√°ng trung b√¨nh: <span id="avg-lux">--</span> lux</p>
    </div>
  </div>

  <!-- Ng∆∞·ª°ng Auto Mode -->
  <div class="card shadow mb-4">
    <div class="card-header bg-danger text-white">Ng∆∞·ª°ng Auto Mode</div>
    <div class="card-body">
      <form method="post" action="/api/thresholds" class="row g-3">
        <div class="col-md-3"><input name="sensorType" class="form-control" placeholder="Sensor" required></div>
        <div class="col-md-2"><select name="comparator" class="form-select"><option value=">">&gt;</option><option value="<">&lt;</option></select></div>
        <div class="col-md-2"><input name="value" type="number" class="form-control" placeholder="Gi√° tr·ªã" required></div>
        <div class="col-md-3"><input name="actions" class="form-control" placeholder="H√†nh ƒë·ªông (vd: fan:ON)" required></div>
        <div class="col-md-2"><button class="btn btn-primary w-100">Th√™m ng∆∞·ª°ng</button></div>
      </form>
      <div id="threshold-list" class="mt-3"></div>
    </div>
  </div>

  <!-- L·ªãch h·∫πn -->
  <div class="card shadow mb-4">
    <div class="card-header bg-secondary text-white">L·ªãch h·∫πn</div>
    <div class="card-body">
      <form method="post" action="/api/schedules" class="row g-3">
        <div class="col-md-3"><input name="deviceId" class="form-control" placeholder="Thi·∫øt b·ªã" required></div>
        <div class="col-md-3"><input name="cron" class="form-control" placeholder="HH:mm" required></div>
        <div class="col-md-3"><input name="action" class="form-control" placeholder="ON/OFF/OPEN/CLOSE/STOP" required></div>
        <div class="col-md-2"><button class="btn btn-primary w-100">Th√™m l·ªãch</button></div>
      </form>
      <div id="schedule-list" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
const socket = io();

// Chart setup
const ctx = document.getElementById('sensorChart');
const sensorChart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [
    { label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: [], borderColor: 'red' },
    { label: 'ƒê·ªô ·∫©m (%)', data: [], borderColor: 'blue' },
    { label: '√Ånh s√°ng (lux)', data: [], borderColor: 'orange' }
  ]}
});

// Devices
socket.on("devices", devices => {
  const statusDiv = document.getElementById("device-status");
  const controlsDiv = document.getElementById("device-controls");
  statusDiv.innerHTML = "";
  controlsDiv.innerHTML = "";
  devices.forEach(d => {
    const isCurtain = d.deviceId === "curtain";
    const status = isCurtain ? (d.state?.mode || "STOP") : (d.state?.on ? "ON" : "OFF");
    const badgeClass = (status==="ON"||status==="OPEN") ? "bg-success" : (status==="CLOSE"?"bg-warning":"bg-secondary");
    statusDiv.innerHTML += `<p><strong>${d.deviceId}:</strong> <span class="badge ${badgeClass}">${status}</span></p>`;
    if(isCurtain){
      const mode = d.state?.mode||"STOP";
      controlsDiv.innerHTML += `
        <form method="post" action="/api/devices/curtain/command" class="btn-group mb-2">
          <button name="cmd" value="OPEN" class="btn ${mode==="OPEN"?"btn-primary active":"btn-outline-primary"}">M·ªü</button>
          <button name="cmd" value="CLOSE" class="btn ${mode==="CLOSE"?"btn-warning active":"btn-outline-warning"}">ƒê√≥ng</button>
          <button name="cmd" value="STOP" class="btn ${mode==="STOP"?"btn-secondary active":"btn-outline-secondary"}">Ng·ª´ng</button>
        </form>`;
    } else {
      const on = !!d.state?.on;
      controlsDiv.innerHTML += `
        <form method="post" action="/api/devices/${d.deviceId}/command" class="btn-group mb-2">
          <button name="cmd" value="ON" class="btn ${on?"btn-success active":"btn-outline-success"}">B·∫≠t</button>
          <button name="cmd" value="OFF" class="btn ${!on?"btn-secondary active":"btn-outline-secondary"}">T·∫Øt</button>
        </form>`;
    }
  });
});

// Sensors
socket.on("sensors", sensors => {
  const temps = sensors.filter(s=>s.sensorType==="temperature").reverse();
  const hums  = sensors.filter(s=>s.sensorType==="humidity").reverse();
  const luxes = sensors.filter(s=>s.sensorType==="lux").reverse();
  sensorChart.data.labels = (temps.length?temps:hums.length?hums:luxes).map(s=>new Date(s.timestamp).toLocaleTimeString());
  sensorChart.data.datasets[0].data = temps.map(s=>s.value);
  sensorChart.data.datasets[1].data = hums.map(s=>s.value);
  sensorChart.data.datasets[2].data = luxes.map(s=>s.value);
  sensorChart.update();
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b.value,0)/arr.length).toFixed(1) : "--";
  document.getElementById("avg-temp").innerText = avg(temps);
  document.getElementById("avg-hum").innerText  = avg(hums);
  document.getElementById("avg-lux").innerText  = avg(luxes);
});

// Thresholds
socket.on("thresholds", list => {
  const div = document.getElementById("threshold-list");
  div.innerHTML = list.length ? `<ul class="list-group">${list.map(t=>`
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span><strong>${t.sensorType}</strong> ${t.comparator} ${t.value} ‚Üí ${t.actions.join(", ")}</span>
      <form method="post" action="/api/thresholds/${t._id}/delete"><button class="btn btn-sm btn-outline-danger">X√≥a</button></form>
    </li>`).join("")}</ul>` : "<p class='text-muted'>Ch∆∞a c√≥ ng∆∞·ª°ng n√†o.</p
    <!-- Thresholds render -->
<script>
socket.on("thresholds", list => {
  const div = document.getElementById("threshold-list");
  if (!list || list.length === 0) {
    div.innerHTML = "<p class='text-muted'>Ch∆∞a c√≥ ng∆∞·ª°ng n√†o.</p>";
    return;
  }
  div.innerHTML = `
    <ul class="list-group">
      ${list.map(t => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>
            <strong>${t.sensorType}</strong> ${t.comparator} ${t.value}
            ‚Üí ${t.actions.join(", ")}
            ${t.timeStart || t.timeEnd ? ` | Khung: ${t.timeStart || "..."} - ${t.timeEnd || "..."}` : ""}
          </span>
          <form method="post" action="/api/thresholds/${t._id}/delete">
            <button class="btn btn-sm btn-outline-danger">X√≥a</button>
          </form>
        </li>`).join("")}
    </ul>`;
});

// Schedules render
socket.on("schedules", list => {
  const div = document.getElementById("schedule-list");
  if (!list || list.length === 0) {
    div.innerHTML = "<p class='text-muted'>Ch∆∞a c√≥ l·ªãch n√†o.</p>";
    return;
  }
  div.innerHTML = `
    <ul class="list-group">
      ${list.map(s => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span><strong>${s.deviceId}</strong> @ ${s.cron} ‚Üí ${s.action}</span>
          <form method="post" action="/api/schedules/${s._id}/delete">
            <button class="btn btn-sm btn-outline-danger">X√≥a</button>
          </form>
        </li>`).join("")}
    </ul>`;
});
</script>
</body>
</html>

